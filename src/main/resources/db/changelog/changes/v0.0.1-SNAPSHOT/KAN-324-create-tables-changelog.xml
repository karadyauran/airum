<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <!-- create tables -->
    <changeSet author="karadyauran" id="create users table">
        <preConditions onFail="CONTINUE" onFailMessage="Table users already exists">
            <not>
                <tableExists tableName="users"/>
            </not>
        </preConditions>
        <createTable tableName="users">
            <column name="u_user_id" type="varchar(60)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="u_username" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="u_name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="u_surname" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="u_email" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="u_password_hash" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="u_created_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="karadyauran" id="create project_members table">
        <preConditions onFail="CONTINUE" onFailMessage="Table project_members already exists">
            <not>
                <tableExists tableName="project_members"/>
            </not>
        </preConditions>
        <createTable tableName="project_members">
            <column name="pm_project_member_id" type="varchar(60)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="pm_user_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="pm_role_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="pm_created_at" type="timestamp" valueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="pm_updated_at" type="timestamp" valueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="karadyauran" id="create projects table">
        <preConditions onFail="CONTINUE" onFailMessage="Table projects already exists">
            <not>
                <tableExists tableName="projects"/>
            </not>
        </preConditions>
        <createTable tableName="projects">
            <column name="p_project_id" type="varchar(60)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="p_owner_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="p_project_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="p_description" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="p_created_at" type="timestamp" valueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="p_updated_at" type="timestamp" valueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="karadyauran" id="create roles table">
        <preConditions onFail="CONTINUE" onFailMessage="Table roles already exists">
            <not>
                <tableExists tableName="roles"/>
            </not>
        </preConditions>
        <createTable tableName="roles">
            <column name="r_role_id" type="varchar(60)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="r_role_name" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="r_role_description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="karadyauran" id="create tasks table">
        <preConditions onFail="CONTINUE" onFailMessage="Table tasks already exists">
            <not>
                <tableExists tableName="task"/>
            </not>
        </preConditions>
        <createTable tableName="tasks">
            <column name="t_task_id" type="varchar(60)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="t_project_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="t_assigned_to_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="t_created_by_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="t_title" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="t_description" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="t_status" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="t_created_at" type="timestamp" valueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="t_due_to" type="timestamp">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="karadyauran" id="create task_comments table">
        <preConditions onFail="CONTINUE" onFailMessage="Table task_comments already exists">
            <not>
                <tableExists tableName="task_comments"/>
            </not>
        </preConditions>
        <createTable tableName="task_comments">
            <column name="tc_comment_id" type="varchar(60)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tc_task_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="tc_user_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="tc_comment" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="tc_created_at" type="timestamp" valueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="karadyauran" id="create task_attachments table">
        <preConditions onFail="CONTINUE" onFailMessage="Table task_attachments already exists">
            <not>
                <tableExists tableName="task_attachments"/>
            </not>
        </preConditions>
        <createTable tableName="task_attachments">
            <column name="ta_attachment_id" type="varchar(60)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ta_task_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="ta_user_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="ta_attachment_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="ta_attachment_type" type="varchar(5)">
                <constraints nullable="false"/>
            </column>
            <column name="ta_attachment_path" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="ta_created_at" type="timestamp" valueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="karadyauran" id="create notifications table">
        <preConditions onFail="CONTINUE" onFailMessage="Table notifications already exists">
            <not>
                <tableExists tableName="notifications"/>
            </not>
        </preConditions>
        <createTable tableName="notifications">
            <column name="n_notification_id" type="varchar(60)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="n_sender_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="n_receiver_id" type="varchar(60)">
                <constraints nullable="false"/>
            </column>
            <column name="n_notification_message" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="n_created_at" type="timestamp" valueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- Set default values for created_at/updated_at columns -->
    <changeSet author="karadyauran" id="add_default_value_to_u_created_at">
        <sql>ALTER TABLE users MODIFY COLUMN u_created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;</sql>
    </changeSet>

    <changeSet author="karadyauran" id="add_default_value_to_tc_created_at">
        <sql>ALTER TABLE task_comments MODIFY COLUMN tc_created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;</sql>
    </changeSet>

    <changeSet author="karadyauran" id="add_default_value_to_ta_created_at">
        <sql>ALTER TABLE task_attachments MODIFY COLUMN ta_created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;</sql>
    </changeSet>

    <changeSet author="karadyauran" id="add_default_value_to_n_created_at">
        <sql>ALTER TABLE notifications MODIFY COLUMN n_created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;</sql>
    </changeSet>

    <changeSet author="karadyauran" id="add_default_value_to_p_created_at">
        <sql>ALTER TABLE projects MODIFY COLUMN p_created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;</sql>
    </changeSet>

    <changeSet author="karadyauran" id="add_default_value_to_p_updated_at">
        <sql>ALTER TABLE projects MODIFY COLUMN p_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;</sql>
    </changeSet>

    <changeSet author="karadyauran" id="add_default_value_to_pm_created_at">
        <sql>ALTER TABLE project_members MODIFY COLUMN pm_created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;</sql>
    </changeSet>

    <changeSet author="karadyauran" id="add_default_value_to_pm_updated_at">
        <sql>ALTER TABLE project_members MODIFY COLUMN pm_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;</sql>
    </changeSet>

    <!-- Add foreign key constraints to existing tables -->

    <!-- Foreign key constraints are added to project_members table -->
    <changeSet author="karadyauran" id="add foreign keys to project_members">
        <preConditions onFail="CONTINUE" onFailMessage="Foreign keys exists">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_project_members_project_id"/>
                <foreignKeyConstraintExists foreignKeyName="fk_project_members_user_id"/>
                <foreignKeyConstraintExists foreignKeyName="fk_project_members_role_id"/>
            </not>
        </preConditions>

        <addForeignKeyConstraint constraintName="fk_project_members_user_id"
                                 baseTableName="project_members" baseColumnNames="pm_user_id"
                                 referencedTableName="users" referencedColumnNames="u_user_id"/>

        <addForeignKeyConstraint constraintName="fk_project_members_role_id"
                                 baseTableName="project_members" baseColumnNames="pm_role_id"
                                 referencedTableName="roles" referencedColumnNames="r_role_id"/>
    </changeSet>

    <!-- Foreign key constraints are added to tasks table -->
    <changeSet author="karadyauran" id="add foreign keys to tasks">
        <preConditions onFail="CONTINUE" onFailMessage="Foreign keys exists">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_tasks_project_id"/>
                <foreignKeyConstraintExists foreignKeyName="fk_tasks_assigned_to_id"/>
                <foreignKeyConstraintExists foreignKeyName="fk_tasks_created_by_id"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint constraintName="fk_tasks_project_id"
                                 baseTableName="tasks" baseColumnNames="t_project_id"
                                 referencedTableName="projects" referencedColumnNames="p_project_id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>

        <addForeignKeyConstraint constraintName="fk_tasks_assigned_to_id"
                                 baseTableName="tasks" baseColumnNames="t_assigned_to_id"
                                 referencedTableName="users" referencedColumnNames="u_user_id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>

        <addForeignKeyConstraint constraintName="fk_tasks_created_by_id"
                                 baseTableName="tasks" baseColumnNames="t_created_by_id"
                                 referencedTableName="users" referencedColumnNames="u_user_id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>

    <!-- Foreign key constraints are added to task_comments table -->
    <changeSet author="karadyauran" id="add foreign keys to task_comments">
        <preConditions onFail="CONTINUE" onFailMessage="Foreign keys exists">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_task_comments_task_id"/>
                <foreignKeyConstraintExists foreignKeyName="fk_task_comments_user_id"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint constraintName="fk_task_comments_task_id"
                                 baseTableName="task_comments" baseColumnNames="tc_task_id"
                                 referencedTableName="tasks" referencedColumnNames="t_task_id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>

        <addForeignKeyConstraint constraintName="fk_task_comments_user_id"
                                 baseTableName="task_comments" baseColumnNames="tc_user_id"
                                 referencedTableName="users" referencedColumnNames="u_user_id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>

    <!-- Foreign key constraints are added to notifications table -->
    <changeSet author="karadyauran" id="add foreign keys to notifications">
        <preConditions onFail="CONTINUE" onFailMessage="Foreign keys exists">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_notifications_sender_id"/>
                <foreignKeyConstraintExists foreignKeyName="fk_notifications_receiver_id"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint constraintName="fk_notifications_sender_id"
                                 baseTableName="notifications" baseColumnNames="n_sender_id"
                                 referencedTableName="users" referencedColumnNames="u_user_id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>

        <addForeignKeyConstraint constraintName="fk_notifications_receiver_id"
                                 baseTableName="notifications" baseColumnNames="n_receiver_id"
                                 referencedTableName="users" referencedColumnNames="u_user_id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>

    <!-- Foreign key constraints are added to task_attachments table -->
    <changeSet author="karadyauran" id="add foreign keys to task_attachments">
        <preConditions onFail="CONTINUE" onFailMessage="Foreign keys exists">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_task_attachments_task_id"/>
                <foreignKeyConstraintExists foreignKeyName="fk_task_attachments_user_id"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint constraintName="fk_task_attachments_task_id"
                                 baseTableName="task_attachments" baseColumnNames="ta_task_id"
                                 referencedTableName="tasks" referencedColumnNames="t_task_id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>

        <addForeignKeyConstraint constraintName="fk_task_attachments_user_id"
                                 baseTableName="task_attachments" baseColumnNames="ta_user_id"
                                 referencedTableName="users" referencedColumnNames="u_user_id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>

    <changeSet author="karadyauran" id="add foreign keys to projects">
    <preConditions onFail="CONTINUE" onFailMessage="Foreign keys exists">
        <not>
            <foreignKeyConstraintExists foreignKeyName="fk_owner_id_user_id"/>
        </not>
    </preConditions>
    <addForeignKeyConstraint constraintName="fk_owner_id_user_id"
                             baseTableName="projects" baseColumnNames="p_owner_id"
                             referencedTableName="users" referencedColumnNames="u_user_id"/>
    </changeSet>

</databaseChangeLog>